# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown –≤ "–ò—Ç–æ–≥–∏ –≤–∞–≥–æ–Ω–æ–≤"

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ "üöÇ –ò—Ç–æ–≥–∏ –≤–∞–≥–æ–Ω–æ–≤" –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: 400: Bad Request: can't parse entities: Can't find end of the entity starting at byte offset 6550
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤, —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∫–æ–º–ø–∞–Ω–∏–π —Å–æ–¥–µ—Ä–∂–∞–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã Markdown, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã.

## –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π:
- `–°–∫–ª–∞–¥ ‚Ññ1 (–æ—Å–Ω–æ–≤–Ω–æ–π)` - –∫—Ä—É–≥–ª—ã–µ —Å–∫–æ–±–∫–∏
- `–¶–µ–º–µ–Ω—Ç –ú-400` - –¥–µ—Ñ–∏—Å
- `–ò–ü –ü–µ—Ç—Ä–æ–≤ –ò.–ò.` - —Ç–æ—á–∫–∏
- `–°–∫–ª–∞–¥ [–†–µ–∑–µ—Ä–≤]` - –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏
- `–¢–û–û {–ö–∞–º–µ–Ω—å}` - —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
```javascript
const escapeMarkdown = (text) => {
    if (!text) return '';
    return text.toString()
        .replace(/\\/g, '\\\\')  // –û–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏
        .replace(/\*/g, '\\*')   // –ó–≤–µ–∑–¥–æ—á–∫–∏
        .replace(/_/g, '\\_')    // –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
        .replace(/\[/g, '\\[')   // –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏
        .replace(/\]/g, '\\]')
        .replace(/\(/g, '\\(')   // –ö—Ä—É–≥–ª—ã–µ —Å–∫–æ–±–∫–∏
        .replace(/\)/g, '\\)')
        .replace(/~/g, '\\~')    // –¢–∏–ª—å–¥–∞
        .replace(/`/g, '\\`')    // –û–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
        .replace(/>/g, '\\>')    // –ë–æ–ª—å—à–µ
        .replace(/#/g, '\\#')    // –†–µ—à–µ—Ç–∫–∞
        .replace(/\+/g, '\\+')   // –ü–ª—é—Å
        .replace(/-/g, '\\-')    // –ú–∏–Ω—É—Å
        .replace(/=/g, '\\=')    // –†–∞–≤–Ω–æ
        .replace(/\|/g, '\\|')   // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —á–µ—Ä—Ç–∞
        .replace(/\{/g, '\\{')   // –§–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏
        .replace(/\}/g, '\\}')
        .replace(/\./g, '\\.')   // –¢–æ—á–∫–∞
        .replace(/!/g, '\\!');   // –í–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫
};
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```javascript
const sendMarkdownMessage = async (ctx, message) => {
    try {
        await ctx.reply(message, { parse_mode: 'Markdown' });
    } catch (error) {
        console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown:', error.message);
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const plainText = message
            .replace(/\*([^*]+)\*/g, '$1')  // –£–±–∏—Ä–∞–µ–º –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
            .replace(/_([^_]+)_/g, '$1')    // –£–±–∏—Ä–∞–µ–º –∫—É—Ä—Å–∏–≤
            .replace(/`([^`]+)`/g, '$1')    // –£–±–∏—Ä–∞–µ–º –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            .replace(/\\(.)/g, '$1');       // –£–±–∏—Ä–∞–µ–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        await ctx.reply(plainText);
    }
};
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "–ò—Ç–æ–≥–∏ –≤–∞–≥–æ–Ω–æ–≤"
```javascript
// –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
msg += `üè™ *${escapeMarkdown(warehouse)}*\n`;
msg += `üì¶ ${escapeMarkdown(item.product)} (${escapeMarkdown(item.company)})\n`;

// –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
await sendMarkdownMessage(ctx, msg);
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
üè™ *–°–∫–ª–∞–¥ ‚Ññ1 (–æ—Å–Ω–æ–≤–Ω–æ–π)*
üì¶ –¶–µ–º–µ–Ω—Ç –ú-400 (–û–û–û "–°—Ç—Ä–æ–π–ú–∞—Ç")
‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown
```

### ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
üè™ *–°–∫–ª–∞–¥ ‚Ññ1 \(–æ—Å–Ω–æ–≤–Ω–æ–π\)*
üì¶ –¶–µ–º–µ–Ω—Ç –ú\-400 (–û–û–û "–°—Ç—Ä–æ–π–ú–∞—Ç")
‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
node test-markdown-escaping.js
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã

### –ü—Ä–∏–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
- `–°–∫–ª–∞–¥ ‚Ññ1 (–æ—Å–Ω–æ–≤–Ω–æ–π)` ‚Üí `–°–∫–ª–∞–¥ ‚Ññ1 \(–æ—Å–Ω–æ–≤–Ω–æ–π\)`
- `–¶–µ–º–µ–Ω—Ç –ú-400` ‚Üí `–¶–µ–º–µ–Ω—Ç –ú\-400`
- `–ò–ü –ü–µ—Ç—Ä–æ–≤ –ò.–ò.` ‚Üí `–ò–ü –ü–µ—Ç—Ä–æ–≤ –ò\.–ò\.`
- `–°–∫–ª–∞–¥ [–†–µ–∑–µ—Ä–≤]` ‚Üí `–°–∫–ª–∞–¥ \[–†–µ–∑–µ—Ä–≤\]`

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è, –¥–∞–∂–µ —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
2. **Fallback** - –µ—Å–ª–∏ Markdown –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤–∏–¥–Ω–æ –∫–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
4. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Å–∫–ª–∞–¥–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

–§—É–Ω–∫—Ü–∏–∏ `escapeMarkdown()` –∏ `sendMarkdownMessage()` –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç—è—Ö –±–æ—Ç–∞:
- –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
- –û—Ç—á–µ—Ç—ã
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ–ª–≥–∞—Ö
- –õ—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–í–µ—Ä—Å–∏—è:** 1.2  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
# üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –û—à–∏–±–∫–∞ –≤ "–ò—Ç–æ–≥–∏ –≤–∞–≥–æ–Ω–æ–≤"

## –ü—Ä–æ–±–ª–µ–º–∞
–í —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "üöÇ –ò—Ç–æ–≥–∏ –≤–∞–≥–æ–Ω–æ–≤" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞ "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö".

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase
```bash
cd telegram-bot
node test-firebase-connection.js
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã
- ‚úÖ –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤ –≤–∞–≥–æ–Ω–æ–≤

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞
```bash
node test-wagon-totals.js
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –§—É–Ω–∫—Ü–∏—è calculateWagonTotals —Ä–∞–±–æ—Ç–∞–µ—Ç
- üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –±–æ—Ç–∞
–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (`node bot.js`) –∏ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—É—á–∏—Ç—å –∏—Ç–æ–≥–∏ –≤–∞–≥–æ–Ω–æ–≤, –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏:

```
üöÇ –ó–∞–ø—Ä–æ—Å –∏—Ç–æ–≥–æ–≤ –≤–∞–≥–æ–Ω–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123456, –≥–æ–¥ 2026
üì° –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã, –∫–ª—é—á–∏: years, warehouses, users, ...
üîç –î–∞–Ω–Ω—ã–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã
üì¶ –ó–∞–ø–∏—Å–µ–π –ø—Ä–∏—Ö–æ–¥–∞ –∑–∞ 2026: 150
üì¶ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏—Ö–æ–¥–∞: 145
‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: 25
üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª–∏–Ω–æ–π 2500 —Å–∏–º–≤–æ–ª–æ–≤
```

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–æ–∫

### 1. –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase
**–°–∏–º–ø—Ç–æ–º—ã:**
- `‚ùå rawData is null`
- `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ`

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `FIREBASE_DATABASE_URL`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª `firebase-service-account.json`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ Firebase Database

### 2. –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ–¥
**–°–∏–º–ø—Ç–æ–º—ã:**
- `‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≥–æ–¥ 2026`
- `‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏—Ö–æ–¥–µ –∑–∞ –≥–æ–¥ 2026`

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤ Firebase –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –Ω—É–∂–Ω—ã–π –≥–æ–¥
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö: `years/2026/income`

### 3. –í—Å–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏—Ö–æ–¥–∞ —É–¥–∞–ª–µ–Ω—ã
**–°–∏–º–ø—Ç–æ–º—ã:**
- `üì¶ –ó–∞–ø–∏—Å–µ–π –ø—Ä–∏—Ö–æ–¥–∞ –∑–∞ 2026: 100`
- `üì¶ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏—Ö–æ–¥–∞: 0`

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–µ `isDeleted` –≤ –∑–∞–ø–∏—Å—è—Ö –ø—Ä–∏—Ö–æ–¥–∞
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

### 4. –û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º —Å–∫–ª–∞–¥–æ–≤
**–°–∏–º–ø—Ç–æ–º—ã:**
- `üì¶ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏—Ö–æ–¥–∞: 0` (–ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–∏—Ö —Å–∫–ª–∞–¥–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø —Å–∫–ª–∞–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í—Ä–µ–º–µ–Ω–Ω–æ –¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–æ–ª—å `admin` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### 5. –û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞
**–°–∏–º–ø—Ç–æ–º—ã:**
- `‚ùå calculateWagonTotals returned null`
- `‚ùå wagonTotals.items is empty`

**–†–µ—à–µ–Ω–∏–µ:**
- –ó–∞–ø—É—Å—Ç–∏—Ç—å `node test-wagon-totals.js`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏—Ö–æ–¥–∞

## –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞, –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é:

```javascript
bot.hears(/üöÇ|–∏—Ç–æ–≥–∏ –≤–∞–≥–æ–Ω–æ–≤/i, async (ctx) => {
    const userId = ctx.from.id;
    const year = getUserYear(userId);
    
    await ctx.reply('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');
    try {
        const data = await getData();
        if (!data || !data.years || !data.years[year] || !data.years[year].income) {
            return ctx.reply(`üöÇ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏—Ö–æ–¥–µ –∑–∞ ${year} –≥–æ–¥`);
        }
        
        const income = data.years[year].income.filter(item => !item.isDeleted);
        const totalWagons = income.length;
        const totalDoc = income.reduce((sum, item) => sum + (parseFloat(item.qtyDoc) || 0), 0);
        const totalFact = income.reduce((sum, item) => sum + (parseFloat(item.qtyFact) || 0), 0);
        
        ctx.reply(
            `üöÇ *–ò–¢–û–ì–ò –í–ê–ì–û–ù–û–í* (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)\nüìÖ ${year}\n\n` +
            `üöÇ –í—Å–µ–≥–æ –≤–∞–≥–æ–Ω–æ–≤: *${totalWagons}*\n` +
            `üìÑ –ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º: *${totalDoc}* —à—Ç\n` +
            `‚úÖ –§–∞–∫—Ç–∏—á–µ—Å–∫–∏: *${totalFact}* —à—Ç\n` +
            `üìà –†–∞–∑–Ω–∏—Ü–∞: *${totalFact - totalDoc}* —à—Ç`,
            { parse_mode: 'Markdown' }
        );
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞:', e);
        ctx.reply(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
    }
});
```

## –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫

- [ ] –ë–æ—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Firebase
- [ ] –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –Ω—É–∂–Ω—ã–π –≥–æ–¥
- [ ] –ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏—Ö–æ–¥–∞
- [ ] –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
- [ ] –í –ª–æ–≥–∞—Ö –Ω–µ—Ç –æ—à–∏–±–æ–∫

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–°—Ç–∞—Ç—É—Å:** üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≥–æ—Ç–æ–≤–∞